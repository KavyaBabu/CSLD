"use client";

import { Page } from "@arqiva/react-component-lib";
import QueryParamsUrlProvider from "@/app/_components/QueryParamsUrlProvider";
import DashboardInner, { DashboardFilters } from "./Inner";
import LeakageListPage from "./widgets/leakageList/page";
import { useEffect, useRef, useState } from "react";
import styles from "./index.module.css";

// Accordion state: closed by default after scroll, open by default at top
const DashboardPage = () => {
  const [dashboardFilters, setDashboardFilters] = useState<DashboardFilters>({});
  const [mounted, setMounted] = useState(false);
  const [isFiltersOpen, setIsFiltersOpen] = useState(true);
  const [filterBarStyle, setFilterBarStyle] = useState<React.CSSProperties>({});
  const contentRef = useRef<HTMLDivElement>(null);

  useEffect(() => setMounted(true), []);

  // Track scroll and auto-collapse filters bar
  useEffect(() => {
    const handleScroll = () => {
      const scrollTop = window.scrollY || document.documentElement.scrollTop;
      setIsFiltersOpen(scrollTop < 40); // open only when at top
    };
    window.addEventListener("scroll", handleScroll);
    return () => window.removeEventListener("scroll", handleScroll);
  }, []);

  // Dynamic fixed bar alignment to main container
  useEffect(() => {
    const updateBar = () => {
      if (contentRef.current) {
        const { offsetLeft, offsetWidth } = contentRef.current;
        setFilterBarStyle({
          left: offsetLeft,
          width: offsetWidth,
        });
      }
    };
    updateBar();
    window.addEventListener("resize", updateBar);
    return () => window.removeEventListener("resize", updateBar);
  }, []);

  if (!mounted) return null;

  return (
    <Page.Root>
      <QueryParamsUrlProvider initialParams={{}}>
        {/* Fixed Accordion Filter Bar */}
        <div
          className={`${styles.dashboard__filters_bar_fixed} ${isFiltersOpen ? styles.open : styles.closed}`}
          style={{
            ...filterBarStyle,
            position: "fixed",
            top: 0,
            zIndex: 1200,
          }}
        >
          <div className={styles.dashboard__filters_bar_inner}>
            <div className={styles.dashboard__filters_header}>
              <h1 className={styles.dashboardTitle}>Dashboard</h1>
              <button
                className={styles.dashboard__filters_toggle}
                aria-label={isFiltersOpen ? "Collapse filters" : "Expand filters"}
                onClick={() => setIsFiltersOpen((open) => !open)}
              >
                {isFiltersOpen ? "Hide filters ▲" : "Show filters ▼"}
              </button>
            </div>
            {isFiltersOpen && (
              <DashboardInner.FiltersBar onFiltersChange={setDashboardFilters} />
            )}
          </div>
        </div>
        <div
          ref={contentRef}
          className={styles.dashboard__content_wrapper}
          style={{ margin: "0 auto", paddingTop: isFiltersOpen ? 170 : 70 }}
        >
          <DashboardInner.Content />
          <div className={styles["dashboard--full-width"]}>
            <h2 className={styles["dashboard__section-heading"]}>
              Leakage List
            </h2>
            <LeakageListPage dashboardFilters={dashboardFilters} />
          </div>
        </div>
      </QueryParamsUrlProvider>
    </Page.Root>
  );
};

export default DashboardPage;




:root {
  --dashboard-bar-padding: 2rem;
  --dashboard-bar-radius: 2rem;
  --dashboard-bar-shadow: 0 2px 8px rgb(0 0 0 / 0.07);
  --dashboard-bar-bg: #fff;
}

.dashboard__filters_bar_fixed {
  background: var(--dashboard-bar-bg);
  border-radius: var(--dashboard-bar-radius);
  box-shadow: var(--dashboard-bar-shadow);
  transition: box-shadow 0.2s, background 0.2s, width 0.2s, left 0.2s;
  /* Don't set left/width here; use dynamic style from JS */
  pointer-events: auto;
}

.dashboard__filters_bar_inner {
  padding: var(--dashboard-bar-padding);
  display: flex;
  flex-direction: column;
  gap: 1.25rem;
}

/* Accordion-style transitions */
.dashboard__filters_bar_fixed.closed .dashboard__filters_bar_inner {
  padding-bottom: 1rem;
}

.dashboard__filters_header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.dashboardTitle {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.dashboard__filters_toggle {
  background: none;
  border: none;
  font-size: 1rem;
  color: var(--primary-600, #2563eb);
  cursor: pointer;
  padding: 0 0.5rem;
}

.dashboard__content_wrapper {
  max-width: 1200px;
  width: 100%;
  margin: 0 auto;
  padding-left: var(--spacing-lg);
  padding-right: var(--spacing-lg);
  /* padding-top set inline by JS for dynamic bar height */
}

.dashboard__section-heading {
  color: var(--grey-900, #111827);
  font-size: var(--text-xl, 1.25rem);
  font-weight: var(--font-semibold, 600);
  line-height: 1.5;
  margin-bottom: var(--spacing-lg, 1rem);
}

.dashboard--full-width {
  width: 100%;
}

/* Responsive: stick to top, use full width on mobile */
@media (max-width: 768px) {
  .dashboard__filters_bar_fixed {
    left: 0 !important;
    width: 100vw !important;
    border-radius: 0 0 var(--dashboard-bar-radius) var(--dashboard-bar-radius);
  }
  .dashboard__content_wrapper {
    max-width: 100vw;
    padding-left: var(--spacing-md);
    padding-right: var(--spacing-md);
  }
}

[data-radix-popover-content],
[data-radix-dialog-content],
.popover-content,
[role="dialog"] {
  z-index: 2000 !important;
}
